<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0d9488">
    <meta name="description" content="Jamaat on Time - Local Masjid Prayer Timings">
    
    <title>Jamaat on Time</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/jot-icon-1-512.png">
    <link rel="icon" type="image/png" href="assets/jot-icon-1-512.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Playfair+Display:wght@700&family=Google+Sans+Code:wght@600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Montserrat', 'sans-serif'], serif: ['Playfair Display', 'serif'], mono: ['Google Sans Code', 'monospace'] },
                    colors: { brand: { 50: '#f0fdfa', 100: '#ccfbf1', 500: '#14b8a6', 600: '#0d9488', 900: '#134e4a' } }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { -webkit-tap-highlight-color: transparent; }
        .animate-card { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .toggle-checkbox:checked { right: 0; border-color: #0d9488; }
        .toggle-checkbox:checked + .toggle-label { background-color: #0d9488; }
        .toggle-label { width: 36px; height: 20px; background-color: #e5e7eb; transition: 0.2s; }
        .toggle-checkbox { right: 16px; transition: 0.2s; width: 16px; height: 16px; top: 2px; }
        .list-btn { padding: 0.375rem 0.75rem; border-radius: 9999px; border: 1px solid #e5e7eb; font-size: 10px; font-weight: 700; color: #6b7280; cursor: pointer; transition: all 0.2s; background-color: white; }
        .dark .list-btn { background-color: #1f2937; border-color: #374151; color: #9ca3af; }
        .list-btn.active { background-color: #0d9488; color: white; border-color: #0d9488; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .restricted { opacity: 0.4; filter: grayscale(100%); }
        .input-field { width: 100%; background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 0.625rem; font-size: 0.875rem; outline: none; transition: border-color 0.2s; }
        .dark .input-field { background-color: #1f2937; border-color: #374151; color: white; }
        .input-field:focus { border-color: #0d9488; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 font-sans transition-colors duration-200">

    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-[60] hidden transition-opacity backdrop-blur-sm"></div>
    <div id="sidebar" class="fixed top-0 left-0 h-full w-72 bg-white dark:bg-gray-800 shadow-2xl z-[70] transform -translate-x-full transition-transform duration-300 ease-in-out p-6 flex flex-col">
        <div class="mb-6 pb-6 border-b border-gray-100 dark:border-gray-700">
            <div id="authSection" class="hidden">
                <div class="flex items-center gap-3 mb-3">
                    <img id="userPhoto" src="" class="w-10 h-10 rounded-full border-2 border-brand-500">
                    <div>
                        <p id="userName" class="text-xs font-bold text-gray-800 dark:text-white truncate max-w-[140px]"></p>
                        <p id="userRoleBadge" class="text-[9px] font-bold uppercase tracking-wider text-brand-600 bg-brand-50 dark:bg-brand-900/30 px-1.5 py-0.5 rounded inline-block">User</p>
                    </div>
                </div>
                <button onclick="handleLogout()" class="text-xs font-bold text-red-500 hover:text-red-700">Log Out</button>
            </div>
            <div id="loginSection">
                <button onclick="handleLogin()" class="w-full flex items-center justify-center gap-2 py-3 bg-gray-900 text-white rounded-xl text-xs font-bold shadow-lg hover:bg-gray-800 transition-colors">
                    <i class="fab fa-google"></i> Sign in to Sync
                </button>
            </div>
        </div>
        <h2 class="text-2xl font-serif font-bold mb-1 text-brand-600 dark:text-brand-400">Settings</h2>
        <div class="space-y-6 flex-1 overflow-y-auto no-scrollbar">
            <div class="flex items-center justify-between">
                <span class="font-bold text-sm">Dark Mode</span>
                <div class="relative inline-block w-10 align-middle select-none">
                    <input type="checkbox" id="theme_toggle" onchange="toggleTheme()" class="toggle-checkbox absolute block rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300"/>
                    <label for="theme_toggle" class="toggle-label block overflow-hidden rounded-full bg-gray-300 cursor-pointer"></label>
                </div>
            </div>
            <hr class="border-gray-100 dark:border-gray-700">
            <div>
                <h3 class="text-[10px] font-bold uppercase text-gray-400 mb-4 tracking-wider">Seasonal Visibility</h3>
                <div class="space-y-4 text-sm font-medium" id="seasonalContainer">
                    <div class="flex justify-between items-center"><span>Ramaḍān</span><input type="checkbox" id="mode_ramadan" onchange="toggleMode('ramadan')" class="accent-brand-600 w-4 h-4"></div>
                    <div class="flex justify-between items-center"><span>Eid-ul-Fiṭr</span><input type="checkbox" id="mode_eidFitr" onchange="toggleMode('eidFitr')" class="accent-brand-600 w-4 h-4"></div>
                    <div class="flex justify-between items-center"><span>Eid-ul-Aḍḥā</span><input type="checkbox" id="mode_eidAdha" onchange="toggleMode('eidAdha')" class="accent-brand-600 w-4 h-4"></div>
                </div>
            </div>
        </div>
        <button id="pwaInstallBtn" class="hidden w-full mt-4 flex items-center justify-center gap-2 py-3 bg-brand-600 text-white rounded-xl text-xs font-bold shadow-lg uppercase tracking-widest">
            <i class="fas fa-download"></i> Install App
        </button>
    </div>

    <div class="fixed top-0 w-full z-40 bg-white/95 dark:bg-gray-800/95 backdrop-blur-md shadow-sm border-b border-gray-100 dark:border-gray-700" id="mainHeader">
        <div class="flex flex-col items-center justify-center pt-2 pb-1 relative h-[50px]">
            <button onclick="toggleSidebar()" class="absolute left-3 top-2.5 text-gray-500 hover:text-brand-600 w-8 h-8 flex items-center justify-center rounded-full transition-colors"><i class="fas fa-bars text-lg"></i></button>
            <h1 class="text-lg font-serif font-bold text-brand-600 dark:text-brand-400 tracking-tight">Jamaat on Time</h1>
            <p class="text-[9px] text-gray-400 font-medium -mt-0.5">by @aekae47</p>
        </div>
        <div id="headerClockView" class="w-full pb-3 h-[90px]">
            <div class="flex flex-col items-center justify-center pt-1 cursor-pointer" onclick="openCityModal()">
                <div class="text-5xl font-mono font-bold text-gray-800 dark:text-white tracking-tighter leading-none flex items-baseline gap-1" id="bigClock">--:-- AM</div>
                <div class="flex items-center gap-1.5 mt-1 text-gray-400 dark:text-gray-500">
                    <i class="fas fa-map-marker-alt text-[10px]"></i>
                    <span class="text-[10px] font-bold uppercase tracking-[0.2em]" id="headerCityName">HYDERABAD</span>
                </div>
            </div>
        </div>
        <div id="headerSearchView" class="hidden px-4 pb-4 h-[65px]">
            <div class="relative mt-2">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs"></i>
                <input type="text" id="searchInput" onkeyup="handleSearch()" placeholder="Search Masājid..." class="w-full bg-gray-100 dark:bg-gray-700/50 border-none rounded-lg py-2.5 pl-9 pr-4 text-xs font-bold outline-none dark:text-white focus:ring-2 focus:ring-brand-500">
            </div>
        </div>
    </div>

    <div id="scrollWrapper" class="pt-[140px] max-w-md mx-auto px-3">
        <div id="filterBarContainer" class="w-full bg-transparent py-2">
            <div class="flex overflow-x-auto no-scrollbar gap-2" id="listBar"></div>
        </div>
        <div class="pb-24 min-h-screen" id="mainContainer">
            <div class="text-center mt-32 text-gray-400 flex flex-col items-center">
                <i class="fas fa-circle-notch fa-spin text-2xl mb-3 text-brand-300"></i>
                <p class="text-xs font-bold uppercase tracking-widest opacity-50">Starting...</p>
            </div>
        </div>
    </div>

    <button id="btnAddFloating" onclick="tryAction('edit', () => openMosqueModal())" class="hidden fixed bottom-20 right-4 w-14 h-14 bg-brand-600 text-white rounded-full shadow-2xl shadow-brand-500/40 flex items-center justify-center z-40 hover:scale-105 transition-transform"><i class="fas fa-plus text-xl"></i></button>

    <div class="fixed bottom-0 w-full bg-white/95 dark:bg-gray-800/95 backdrop-blur-md border-t border-gray-200 dark:border-gray-700 p-2 flex justify-around z-40 pb-4">
        <button onclick="setViewMode('next')" class="nav-btn w-16 group flex flex-col items-center justify-center" id="nav_next">
            <i class="fas fa-clock text-lg mb-1"></i>
            <span class="text-[10px] font-bold">Prayer</span>
        </button>
        <button onclick="setViewMode('list')" class="nav-btn w-16 group flex flex-col items-center justify-center" id="nav_list">
            <i class="fas fa-mosque text-lg mb-1"></i>
            <span class="text-[10px] font-bold">Masājid</span>
        </button>
    </div>

    <div id="accessDeniedModal" class="hidden fixed inset-0 z-[90] bg-black/70 backdrop-blur-sm flex items-center justify-center p-6 text-center">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-xs p-6 shadow-2xl animate-card">
            <div class="w-12 h-12 bg-red-50 dark:bg-red-900/20 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-lock"></i></div>
            <h3 class="text-lg font-serif font-bold mb-2 text-gray-800 dark:text-white">Restricted Access</h3>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-6">Only admins and volunteers can perform this action.</p>
            <button onclick="closeModal('accessDeniedModal')" class="w-full py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl text-xs font-bold uppercase">Close</button>
        </div>
    </div>

    <div id="mosqueInfoModal" class="hidden fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-card max-h-[90vh] overflow-y-auto no-scrollbar">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-lg font-serif font-bold dark:text-white" id="mosqueModalTitle">Masjid Info</h3>
                <button id="btnDeleteMosqueHeader" onclick="deleteMosque()" class="text-red-500 p-2 rounded-lg bg-red-50 dark:bg-red-900/20"><i class="fas fa-trash-alt"></i></button>
            </div>
            <input type="hidden" id="editMosqueId">
            <div class="space-y-4">
                <div><label class="text-[10px] font-bold text-gray-400 uppercase">Name</label><input type="text" id="m_name" class="input-field font-bold"></div>
                <div><label class="text-[10px] font-bold text-gray-400 uppercase">Area</label><input type="text" id="m_area" class="input-field"></div>
                <div class="bg-gray-50 dark:bg-gray-900/50 p-3 rounded-xl"><label class="text-[10px] font-bold text-gray-400 uppercase">Lists</label><div id="listChipsContainer" class="flex flex-wrap gap-2 mt-2"></div></div>
                <div><label class="text-[10px] font-bold text-gray-400 uppercase">Maps Link</label><input type="url" id="m_link" class="input-field text-xs"></div>
            </div>
            <div class="mt-8 flex flex-col gap-2 pt-4 border-t dark:border-gray-700">
                <button onclick="saveMosqueInfo(true)" class="w-full py-2.5 bg-brand-500 text-white rounded-xl text-[11px] font-bold uppercase">Save & Edit Timings</button>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="closeModal('mosqueInfoModal')" class="py-2.5 bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300 rounded-xl text-[11px] font-bold uppercase">Cancel</button>
                    <button onclick="saveMosqueInfo(false)" class="py-2.5 bg-brand-600 text-white rounded-xl text-[11px] font-bold uppercase">Save & Exit</button>
                </div>
            </div>
        </div>
    </div>

    <div id="citySelectionModal" class="hidden fixed inset-0 z-[80] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4"><div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm shadow-2xl p-5 animate-card"><h3 class="font-serif font-bold mb-4 dark:text-white">Select City</h3><div id="cityListContainer" class="max-h-64 overflow-y-auto no-scrollbar"></div></div></div>
    <div id="editTimingModal" class="hidden fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4"><div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm p-5 shadow-2xl max-h-[90vh] overflow-y-auto no-scrollbar"><h3 id="timingModalMosqueName" class="font-bold mb-4 dark:text-white">Timings</h3><div id="timingEditorContainer"></div><button onclick="saveTimings()" class="w-full mt-6 py-3 bg-brand-600 text-white rounded-xl font-bold uppercase">Save Timings</button></div></div>
    <div id="mosqueDetailModal" class="hidden fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4"><div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm p-6 shadow-2xl"><h2 id="detail_name" class="text-xl font-bold dark:text-white"></h2><div id="detail_timings" class="mt-4"></div><button onclick="closeModal('mosqueDetailModal')" class="w-full mt-6 py-2 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl font-bold">Close</button></div></div>
    <div id="toast" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-5 py-2.5 rounded-full text-xs font-bold shadow-2xl opacity-0 transition-all duration-300 z-[100] pointer-events-none translate-y-4">Saved Successfully</div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAEzXz42Zih7M6yY97_4e8_E1BNsjbJhnI", authDomain: "timings-ak.firebaseapp.com", projectId: "timings-ak", storageBucket: "timings-ak.firebasestorage.app", messagingSenderId: "1082790063422", appId: "1:1082790063422:web:be439e3d932475a9fe906f" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        let viewMode = 'next', currentList = 'Favorites', searchQuery = '', mosques = [], allLists = new Set(['Favorites', 'Home', 'Work']);
        let appSettings = { ramadan: false, eidFitr: false, eidAdha: false, qiyam: false, lateIsha: false, theme: 'light', city: 'Hyderabad' };
        let currentUser = null, userRole = 'public', currentTimeDisplay = '', currentTargetPrayer = 'fajr';
        const prayersList = [ { id: 'fajr', name: 'Fajr', icon: 'fa-cloud-sun' }, { id: 'zuhr', name: 'Ẓuhr', icon: 'fa-sun' }, { id: 'asr', name: 'Aṣr', icon: 'fa-cloud' }, { id: 'isha', name: 'Ishā', icon: 'fa-moon' }, { id: 'jumma', name: 'Jumma', icon: 'fa-users' } ];

        // FIXED: Defined showToast globally to prevent ReferenceError
        window.showToast = () => {
            const t = document.getElementById('toast');
            t.classList.remove('opacity-0', 'translate-y-4');
            t.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                t.classList.add('opacity-0', 'translate-y-4');
                t.classList.remove('opacity-100', 'translate-y-0');
            }, 2000);
        };

        window.closeModal = (id) => document.getElementById(id)?.classList.add('hidden');
        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('-translate-x-full'); document.getElementById('sidebarOverlay').classList.toggle('hidden'); };
        window.toggleTheme = () => { appSettings.theme = appSettings.theme === 'dark' ? 'light' : 'dark'; localStorage.setItem('theme', appSettings.theme); document.documentElement.classList.toggle('dark'); };
        window.setViewMode = (mode) => { viewMode = mode; renderApp(); };
        window.switchList = (name) => { currentList = name; renderApp(); renderListBar(); };
        window.handleSearch = () => { searchQuery = document.getElementById('searchInput').value.toLowerCase(); renderApp(); };

        window.tryAction = (type, callback) => {
            if (userRole === 'volunteer' || userRole === 'admin') return callback();
            document.getElementById('accessDeniedModal').classList.remove('hidden');
        };

        window.saveMosqueInfo = async (goToTimings = false) => {
            const id = document.getElementById('editMosqueId').value;
            const data = { 
                name: document.getElementById('m_name').value, 
                area: document.getElementById('m_area').value, 
                city: appSettings.city,
                lists: Array.from(document.querySelectorAll('#listChipsContainer .list-btn.active')).map(c=>c.innerText),
                locationLink: document.getElementById('m_link').value
            };
            if(!data.name) return alert("Name required");
            let savedId = id;
            if(id) await db.collection('mosques').doc(id).update(data);
            else { data.order = -Date.now(); data.timings = {}; const ref = await db.collection('mosques').add(data); savedId = ref.id; }
            window.showToast(); // Call fixed showToast
            closeModal('mosqueInfoModal');
            if(goToTimings) window.openEditTiming(savedId);
        };

        // UI Rendering Logic (Simplified for stability)
        function renderApp() {
            const isList = viewMode === 'list';
            document.getElementById('headerClockView').classList.toggle('hidden', isList);
            document.getElementById('headerSearchView').classList.toggle('hidden', !isList);
            document.getElementById('btnAddFloating').classList.toggle('hidden', !isList);
            document.getElementById('scrollWrapper').style.paddingTop = isList ? '115px' : '140px';
            renderListBar();
            loadDataDisplay();
        }

        function renderListBar() {
            const container = document.getElementById('listBar');
            container.innerHTML = ['Favorites', 'All', ...allLists].filter((v, i, a) => a.indexOf(v) === i).map(list => 
                `<button onclick="switchList('${list}')" class="list-btn ${currentList === list ? 'active' : ''}">${list}</button>`
            ).join('');
        }

        function loadDataDisplay() {
            const container = document.getElementById('mainContainer');
            const filtered = mosques.filter(m => (m.city === appSettings.city) && (currentList === 'All' || m.lists?.includes(currentList)) && (m.name.toLowerCase().includes(searchQuery) || m.area.toLowerCase().includes(searchQuery)));
            container.innerHTML = filtered.map(m => `
                <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm mb-3 animate-card border-l-4 border-brand-500">
                    <div class="flex justify-between items-start">
                        <div onclick="window.openMosqueDetail('${m.id}')" class="cursor-pointer">
                            <h3 class="font-bold dark:text-white">${m.name}</h3>
                            <p class="text-[10px] text-gray-400">${m.area}</p>
                        </div>
                        <button onclick="window.tryAction('edit', () => window.openMosqueModal('${m.id}'))" class="text-brand-600"><i class="fas fa-pencil-alt text-xs"></i></button>
                    </div>
                </div>
            `).join('');
        }

        async function init() {
            appSettings.theme = localStorage.getItem('theme') || 'light';
            if(appSettings.theme === 'dark') document.documentElement.classList.add('dark');
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const doc = await db.collection('users').doc(user.uid).get();
                    userRole = doc.exists ? doc.data().role : 'user';
                    document.getElementById('authSection').classList.remove('hidden');
                    document.getElementById('loginSection').classList.add('hidden');
                }
                db.collection('mosques').onSnapshot(snap => {
                    mosques = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderApp();
                });
            });
            updateClock(); setInterval(updateClock, 1000);
        }
        window.onload = init;
    </script>
</body>
</html>
