<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0d9488">
    <meta name="description" content="Jamaat on Time - Local Masjid Prayer Timings">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://aekae47.github.io/jamaat-timings/"> <meta property="og:title" content="Jamaat on Time">
    <meta property="og:description" content="Local Masjid Prayer Timings at your fingertips. Punctual prayers, unified Ummah.">
    <meta property="og:image" content="https://raw.githubusercontent.com/aekae47/jamaat-timings/refs/heads/main/assets/1200x630.jpg"> <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://aekae47.github.io/jamaat-timings/">
    <meta property="twitter:title" content="Jamaat on Time">
    <meta property="twitter:description" content="Local Masjid Prayer Timings at your fingertips.">
    <meta property="twitter:image" content="https://raw.githubusercontent.com/aekae47/jamaat-timings/refs/heads/main/assets/1200x630.jpg">
    
    <title>Jamaat on Time</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/jot-icon-1-512.png">
    <link rel="icon" type="image/png" href="assets/jot-icon-1-512.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Playfair+Display:wght@700&family=Google+Sans+Code:wght@600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Montserrat', 'sans-serif'], serif: ['Playfair Display', 'serif'], mono: ['Google Sans Code', 'monospace'] },
                    colors: { brand: { 50: '#f0fdfa', 100: '#ccfbf1', 500: '#14b8a6', 600: '#0d9488', 900: '#134e4a' } }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { -webkit-tap-highlight-color: transparent; }
        .animate-card { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .toggle-checkbox:checked { right: 0; border-color: #0d9488; }
        .toggle-checkbox:checked + .toggle-label { background-color: #0d9488; }
        .toggle-label { width: 36px; height: 20px; background-color: #e5e7eb; transition: 0.2s; }
        .toggle-checkbox { right: 16px; transition: 0.2s; width: 16px; height: 16px; top: 2px; }
        .list-btn { padding: 0.375rem 0.75rem; border-radius: 9999px; border: 1px solid #e5e7eb; font-size: 10px; font-weight: 700; color: #6b7280; cursor: pointer; transition: all 0.2s; background-color: white; }
        .dark .list-btn { background-color: #1f2937; border-color: #374151; color: #9ca3af; }
        .list-btn.active { background-color: #0d9488; color: white; border-color: #0d9488; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .restricted { opacity: 0.4; filter: grayscale(100%); }
        .input-field { width: 100%; background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 0.625rem; font-size: 0.875rem; outline: none; transition: border-color 0.2s; }
        .dark .input-field { background-color: #1f2937; border-color: #374151; color: white; }
        .input-field:focus { border-color: #0d9488; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 font-sans transition-colors duration-200">

    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-[60] hidden transition-opacity backdrop-blur-sm"></div>
    <div id="sidebar" class="fixed top-0 left-0 h-full w-72 bg-white dark:bg-gray-800 shadow-2xl z-[70] transform -translate-x-full transition-transform duration-300 ease-in-out p-6 flex flex-col">
        <div class="mb-6 pb-6 border-b border-gray-100 dark:border-gray-700">
            <div id="authSection" class="hidden">
                <div class="flex items-center gap-3 mb-3">
                    <img id="userPhoto" src="" class="w-10 h-10 rounded-full border-2 border-brand-500">
                    <div>
                        <p id="userName" class="text-xs font-bold text-gray-800 dark:text-white truncate max-w-[140px]"></p>
                        <p id="userRoleBadge" class="text-[9px] font-bold uppercase tracking-wider text-brand-600 bg-brand-50 dark:bg-brand-900/30 px-1.5 py-0.5 rounded inline-block">User</p>
                    </div>
                </div>
                <button onclick="handleLogout()" class="text-xs font-bold text-red-500 hover:text-red-700">Log Out</button>
            </div>
            <div id="loginSection">
                <button onclick="handleLogin()" class="w-full flex items-center justify-center gap-2 py-3 bg-gray-900 text-white rounded-xl text-xs font-bold shadow-lg hover:bg-gray-800 transition-colors">
                    <i class="fab fa-google"></i> Sign in to Sync
                </button>
            </div>
        </div>

        <h2 class="text-2xl font-serif font-bold mb-1 text-brand-600 dark:text-brand-400">Settings</h2>
        <p class="text-xs text-gray-400 mb-8 uppercase tracking-widest">Preferences</p>
        
        <div class="space-y-6 flex-1">
            <div class="flex items-center justify-between">
                <span class="font-bold text-sm">Dark Mode</span>
                <div class="relative inline-block w-10 align-middle select-none">
                    <input type="checkbox" id="theme_toggle" onchange="toggleTheme()" class="toggle-checkbox absolute block rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300"/>
                    <label for="theme_toggle" class="toggle-label block overflow-hidden rounded-full bg-gray-300 cursor-pointer"></label>
                </div>
            </div>

            <hr class="border-gray-100 dark:border-gray-700">

            <div>
                <h3 class="text-[10px] font-bold uppercase text-gray-400 mb-4 tracking-wider flex justify-between items-center">
                    Seasonal Visibility
                    <i class="fas fa-lock text-[9px] opacity-30"></i>
                </h3>
                <div class="space-y-4 text-sm font-medium" id="seasonalContainer">
                    <div class="flex justify-between items-center"><span>Ramaḍān</span><input type="checkbox" id="mode_ramadan" onchange="toggleMode('ramadan')" class="accent-brand-600 w-4 h-4"></div>
                    <div class="flex justify-between items-center"><span>Eid-ul-Fiṭr</span><input type="checkbox" id="mode_eidFitr" onchange="toggleMode('eidFitr')" class="accent-brand-600 w-4 h-4"></div>
                    <div class="flex justify-between items-center"><span>Eid-ul-Aḍḥā</span><input type="checkbox" id="mode_eidAdha" onchange="toggleMode('eidAdha')" class="accent-brand-600 w-4 h-4"></div>
                    <div class="flex justify-between items-center"><span>Qiyām-ul-Layl</span><input type="checkbox" id="mode_qiyam" onchange="toggleMode('qiyam')" class="accent-brand-600 w-4 h-4"></div>
                    <div class="flex justify-between items-center"><span>Late Ishā</span><input type="checkbox" id="mode_lateIsha" onchange="toggleMode('lateIsha')" class="accent-brand-600 w-4 h-4"></div>
                </div>
            </div>
        </div>
        <button id="pwaInstallBtn" class="hidden w-full mt-4 flex items-center justify-center gap-2 py-3 bg-brand-600 text-white rounded-xl text-xs font-bold shadow-lg uppercase tracking-widest">
            <i class="fas fa-download"></i> Install App
        </button>
    </div>

    <div class="fixed top-0 w-full z-40 bg-white/95 dark:bg-gray-800/95 backdrop-blur-md shadow-sm border-b border-gray-100 dark:border-gray-700 h-[115px] transition-all" id="mainHeader">
        <div class="flex flex-col items-center justify-center pt-2 pb-1 relative h-[50px]">
            <button onclick="toggleSidebar()" class="absolute left-3 top-2.5 text-gray-500 hover:text-brand-600 w-8 h-8 flex items-center justify-center rounded-full transition-colors"><i class="fas fa-bars text-lg"></i></button>
            <h1 class="text-lg font-serif font-bold text-brand-600 dark:text-brand-400 tracking-tight">Jamaat on Time</h1>
            <p class="text-[9px] text-gray-400 font-medium -mt-0.5">by @aekae47</p>
        </div>

        <div id="headerClockView" class="w-full h-[65px]">
            <div class="flex flex-col items-center justify-center pt-0.5 cursor-pointer" onclick="openCityModal()">
                <div class="text-4xl font-mono font-bold text-gray-800 dark:text-white tracking-tighter leading-none flex items-baseline gap-1" id="bigClock">--:-- AM</div>
                <div class="flex items-center gap-1.5 mt-0.5 text-gray-400 dark:text-gray-500">
                    <i class="fas fa-map-marker-alt text-[9px]"></i>
                    <span class="text-[10px] font-bold uppercase tracking-[0.2em]" id="headerCityName">HYDERABAD</span>
                </div>
                <div id="fridayBadge" class="hidden mt-1 bg-brand-50 text-brand-600 px-2 py-0.5 rounded-full text-[8px] font-bold uppercase tracking-widest">It's Friday!</div>
            </div>
        </div>

        <div id="headerSearchView" class="hidden px-4 pt-1 pb-2">
            <div class="relative">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs"></i>
                <input type="text" id="searchInput" onkeyup="handleSearch()" placeholder="Search Masājid..." class="w-full bg-gray-100 dark:bg-gray-700/50 border-none rounded-lg py-2 pl-9 pr-4 text-xs font-bold outline-none dark:text-white focus:ring-2 focus:ring-brand-500">
            </div>
        </div>
    </div>

    <div id="scrollWrapper" class="pt-[115px] max-w-md mx-auto px-3">
        <div id="filterBarContainer" class="w-full bg-transparent py-2">
            <div class="flex overflow-x-auto no-scrollbar gap-2" id="listBar"></div>
        </div>
        
        <div class="pb-24 min-h-screen" id="mainContainer">
            <div class="text-center mt-32 text-gray-400 flex flex-col items-center">
                <i class="fas fa-circle-notch fa-spin text-2xl mb-3 text-brand-300"></i>
                <p class="text-xs font-bold uppercase tracking-widest opacity-50">Starting...</p>
            </div>
        </div>
    </div>

    <button id="btnAddFloating" onclick="tryAction('edit', () => openMosqueModal())" class="hidden fixed bottom-20 right-4 w-14 h-14 bg-brand-600 text-white rounded-full shadow-2xl shadow-brand-500/40 flex items-center justify-center z-40 hover:scale-105 transition-transform"><i class="fas fa-plus text-xl"></i></button>

    <div class="fixed bottom-0 w-full bg-white/95 dark:bg-gray-800/95 backdrop-blur-md border-t border-gray-200 dark:border-gray-700 p-2 flex justify-around z-40 pb-4">
        <button onclick="setViewMode('next')" class="nav-btn w-16 group flex flex-col items-center justify-center" id="nav_next">
            <i class="fas fa-clock text-lg mb-1"></i>
            <span class="text-[10px] font-bold">Prayer</span>
        </button>
        <button onclick="setViewMode('list')" class="nav-btn w-16 group flex flex-col items-center justify-center" id="nav_list">
            <i class="fas fa-mosque text-lg mb-1"></i>
            <span class="text-[10px] font-bold">Masājid</span>
        </button>
        <button onclick="setViewMode('info')" class="nav-btn w-16 group flex flex-col items-center justify-center" id="nav_info">
            <i class="fas fa-info-circle text-lg mb-1"></i>
            <span class="text-[10px] font-bold">Info</span>
        </button>
    </div>

    <div id="personalListModal" class="hidden fixed inset-0 z-[100] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-card">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-lg font-serif font-bold dark:text-white">Add to Personal List</h3>
                <button onclick="closeModal('personalListModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <input type="hidden" id="listTargetMosqueId">
            <div id="personalListContainer" class="space-y-2 mb-6 max-h-[40vh] overflow-y-auto no-scrollbar"></div>
            <div class="flex gap-2">
                <input type="text" id="newPersonalListInput" placeholder="New list name..." class="flex-1 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg px-3 py-2 text-xs font-bold dark:text-white outline-none">
                <button onclick="createNewPersonalList()" class="bg-brand-600 text-white px-4 py-2 rounded-lg text-xs font-bold"><i class="fas fa-plus"></i></button>
            </div>
            <button onclick="closeModal('personalListModal')" class="w-full mt-6 py-3 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-xl text-xs font-bold uppercase">Close</button>
        </div>
    </div>

    <div id="accessDeniedModal" class="hidden fixed inset-0 z-[90] bg-black/70 backdrop-blur-sm flex items-center justify-center p-6 text-center">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-xs p-6 shadow-2xl animate-card">
            <div class="w-12 h-12 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-lock"></i></div>
            <h3 class="text-lg font-serif font-bold mb-2 text-gray-800 dark:text-white">Restricted Access</h3>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-6">Only admins and volunteers can edit database details. Apply at our <a href="https://t.me/+cjZjOMlnINUxMmU1" target="_blank" class="text-brand-600 underline font-bold">Telegram group</a></p>
            <button onclick="closeModal('accessDeniedModal')" class="w-full py-3 bg-gray-100 dark:bg-gray-700 dark:text-gray-200 rounded-xl text-xs font-bold uppercase">Close</button>
        </div>
    </div>

    <div id="citySelectionModal" class="hidden fixed inset-0 z-[80] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm shadow-2xl animate-card overflow-hidden">
            <div class="p-5 border-b border-gray-100 dark:border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-serif font-bold dark:text-white">Select City</h3>
                    <button onclick="closeModal('citySelectionModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="newCityInput" placeholder="Add new city..." class="flex-1 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-lg px-3 py-2 text-xs font-bold outline-none focus:border-brand-500 dark:text-white">
                    <button onclick="addNewCity()" class="bg-brand-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow hover:bg-brand-700"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div id="cityListContainer" class="max-h-[60vh] overflow-y-auto no-scrollbar p-2"></div>
        </div>
    </div>

    <div id="mosqueDetailModal" class="hidden fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm max-h-[85vh] shadow-2xl flex flex-col animate-card overflow-hidden">
            <div class="p-5 border-b border-gray-100 dark:border-gray-700 bg-gray-50/50 dark:bg-gray-700/20 flex justify-between items-start">
                <div class="flex items-start gap-3">
                    <i class="fas fa-mosque text-brand-600 dark:text-brand-400 text-xl mt-1"></i>
                    <div><h2 class="text-xl font-serif font-bold text-gray-800 dark:text-white leading-tight" id="detail_name">Name</h2><p class="text-xs font-bold text-gray-500 dark:text-gray-400 mt-1" id="detail_area">Area</p></div>
                </div>
                <div class="flex gap-2">
                    <button id="btnEditDetail" onclick="tryAction('edit', () => openMosqueModal(currentDetailId))" class="w-8 h-8 rounded-full bg-brand-50 text-brand-600 flex items-center justify-center hover:bg-brand-100"><i class="fas fa-pencil-alt text-xs"></i></button>
                    <button onclick="closeModal('mosqueDetailModal')" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-500 flex items-center justify-center hover:bg-gray-200"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto no-scrollbar p-5">
                <div id="detail_timings" class="space-y-2 mb-6 cursor-pointer"></div>
                <div class="bg-gray-50 dark:bg-gray-700/30 rounded-xl p-4 border border-gray-100 dark:border-gray-600">
                    <h4 class="text-[10px] font-bold text-gray-400 uppercase mb-2 tracking-wider">Notes</h4>
                    <p id="detail_notes" class="text-xs text-gray-600 dark:text-gray-300 whitespace-pre-line leading-relaxed"></p>
                </div>
            </div>
            <div class="p-4 border-t border-gray-100 dark:border-gray-700">
                <a id="detail_directions" href="#" target="_blank" class="flex items-center justify-center w-full bg-brand-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-brand-700"><i class="fas fa-location-arrow mr-2"></i> Directions</a>
            </div>
        </div>
    </div>

    <div id="mosqueInfoModal" class="hidden fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-card max-h-[90vh] overflow-y-auto no-scrollbar relative">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-lg font-serif font-bold dark:text-white" id="mosqueModalTitle">Add Masjid</h3>
                <button id="btnDeleteMosqueHeader" onclick="deleteMosque()" class="text-red-500 hover:text-red-700 p-2 rounded-lg bg-red-50 dark:bg-red-900/20 flex transition-colors"><i class="fas fa-trash-alt text-lg"></i></button>
            </div>
            <input type="hidden" id="editMosqueId">
            <div class="space-y-4">
                <div><label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Name</label><input type="text" id="m_name" class="input-field font-bold" placeholder="Masjid-e-..."></div>
                <div><label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Area</label><input type="text" id="m_area" class="input-field" placeholder="Area"></div>
                <div><label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Maps Link</label><input type="url" id="m_link" class="input-field text-xs" placeholder="https://maps.google..."></div>
                <div><label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Location Instructions</label><textarea id="m_notes" rows="2" class="input-field text-xs" placeholder="Notes..."></textarea></div>
            </div>
            <div class="mt-6 flex flex-row items-center justify-between gap-2 pt-4 border-t border-gray-100 dark:border-gray-700">
                <button onclick="saveMosqueInfo(true)" class="flex-1 py-2 bg-brand-50 dark:bg-brand-900/40 text-brand-600 dark:text-brand-400 rounded-lg text-[9px] font-bold uppercase transition-colors">Edit Timings</button>
                <button onclick="saveMosqueInfo(false)" class="flex-1 py-2 bg-brand-600 text-white rounded-lg text-[9px] font-bold shadow-md uppercase">Save & Exit</button>
                <button onclick="closeModal('mosqueInfoModal')" class="px-3 py-2 text-[9px] font-bold text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 rounded-lg uppercase">Cancel</button>
            </div>
        </div>
    </div>

    <div id="editTimingModal" class="hidden fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm p-5 shadow-2xl animate-card max-h-[90vh] overflow-y-auto no-scrollbar">
            <div class="flex justify-between items-center mb-5 pb-3 border-b border-gray-100 dark:border-gray-700">
                <h3 class="text-lg font-serif font-bold dark:text-white" id="timingModalMosqueName">Timings</h3>
                <button onclick="closeModal('editTimingModal')" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div id="timingEditorContainer" class="space-y-3"></div>
            <div class="mt-5 pt-3 border-t border-gray-100 dark:border-gray-700">
                <button onclick="toggleSpecialPrayers()" class="w-full flex justify-between items-center text-xs font-bold text-gray-500 bg-gray-50 dark:bg-gray-700/50 p-3 rounded-xl"><span>SPECIAL PRAYERS</span><i id="specialChevron" class="fas fa-chevron-down"></i></button>
                <div id="specialPrayersContainer" class="hidden mt-3 space-y-3 p-2"></div>
            </div>
            <button onclick="saveTimings()" class="w-full mt-6 py-3 bg-brand-600 text-white rounded-xl text-sm font-bold shadow-lg uppercase">Save Timings</button>
        </div>
    </div>

    <div id="toast" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-5 py-2.5 rounded-full text-xs font-bold shadow-2xl opacity-0 transition-all duration-300 z-50 pointer-events-none translate-y-4"><i class="fas fa-check-circle text-brand-400 mr-2"></i><span>Saved</span></div>

    <script>
        // --- GLOBAL FUNCTIONS DEFINED FIRST ---
        window.updateSidebarToggles = () => {
            ['ramadan', 'eidFitr', 'eidAdha', 'qiyam', 'lateIsha'].forEach(k => {
                const el = document.getElementById(`mode_${k}`); if(el) el.checked = appSettings[k];
            });
        };
        window.closeModal = (id) => document.getElementById(id)?.classList.add('hidden');
        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('-translate-x-full'); document.getElementById('sidebarOverlay').classList.toggle('hidden'); };
        window.setViewMode = (mode) => { viewMode = mode; renderApp(); };
        window.switchList = (name) => { currentList = name; renderApp(); renderListBar(); };
        window.toggleChip = (el) => el.classList.toggle('active');
        window.formatTime12 = (time24, pid = null) => { 
            if (!time24 || time24.trim() === '') return '--:--'; 
            if (pid === 'taraweeh') return `${time24} <span class="text-[9px] uppercase font-bold text-gray-400">Pārahs</span>`;
            const [h, m] = time24.split(':'); let hours = parseInt(h); const suffix = hours >= 12 ? 'PM' : 'AM'; hours = hours % 12 || 12; return `${hours}:${String(m).padStart(2,'0')}<span class="text-[10px] ml-0.5 font-normal text-gray-400">${suffix}</span>`; 
        };
        window.formatUpdateDate = (iso) => { if(!iso) return ''; const d = new Date(iso); return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }); };
        window.showToast = () => { const t = document.getElementById('toast'); t.classList.replace('opacity-0', 'opacity-100'); t.classList.replace('translate-y-4', 'translate-y-0'); setTimeout(() => { t.classList.replace('opacity-100', 'opacity-0'); t.classList.replace('translate-y-0', 'translate-y-4'); }, 2000); };
        window.handleSearch = () => { searchQuery = document.getElementById('searchInput').value.toLowerCase(); renderApp(); };
        window.toggleMode = async (key) => { if(userRole !== 'admin') { document.getElementById(`mode_${key}`).checked = appSettings[key]; return window.tryAction('admin', ()=>{}); } appSettings[key] = !appSettings[key]; await db.collection('settings').doc('global_modes').set({[key]: appSettings[key]}, {merge: true}); };
        window.toggleTheme = () => { const isDark = document.getElementById('theme_toggle').checked; document.documentElement.classList.toggle('dark', isDark); localStorage.setItem('theme', isDark ? 'dark' : 'light'); appSettings.theme = isDark ? 'dark' : 'light'; };
        window.handleLogout = () => auth.signOut();
        window.handleLogin = () => auth.signInWithPopup(provider);

        // --- GLOBALS ---
        let viewMode = 'next', currentList = 'Favorites', searchQuery = '', mosques = [];
        let editingTimingsId = null, currentDetailId = null, currentTimeDisplay = '', currentTargetPrayer = 'fajr';
        let appSettings = { ramadan: false, eidFitr: false, eidAdha: false, qiyam: false, lateIsha: false, theme: 'light', city: 'Hyderabad' };
        let currentUser = null, userRole = 'public';
        let availableCities = new Set(['Hyderabad']);
        let personalLists = { Favorites: [], Home: [], Work: [] };
        let customOrder = [];

        const prayersList = [ { id: 'fajr', name: 'Fajr', icon: 'fa-cloud-sun' }, { id: 'zuhr', name: 'Ẓuhr', icon: 'fa-sun' }, { id: 'asr', name: 'Aṣr', icon: 'fa-cloud' }, { id: 'isha', name: 'Ishā', icon: 'fa-moon' }, { id: 'jumma', name: 'Jumma', icon: 'fa-users' } ];
        const sequenceOrder = ['fajr', 'zuhr', 'asr', 'isha']; 
        const specialPrayersList = [ { id: 'taraweeh', name: 'Tarāweeḥ', type: 'parahs', mode: 'ramadan' }, { id: 'eidFitr', name: 'Eid-ul-Fiṭr Prayer', mode: 'eidFitr' }, { id: 'eidAdha', name: 'Eid-ul-Aḍḥā Prayer', mode: 'eidAdha' }, { id: 'qiyam', name: 'Qiyām-ul-Layl', mode: 'qiyam' }, { id: 'lateIsha', name: 'Late Ishā', mode: 'lateIsha' } ];

        const firebaseConfig = { apiKey: "AIzaSyAEzXz42Zih7M6yY97_4e8_E1BNsjbJhnI", authDomain: "timings-ak.firebaseapp.com", projectId: "timings-ak", storageBucket: "timings-ak.firebasestorage.app", messagingSenderId: "1082790063422", appId: "1:1082790063422:web:be439e3d932475a9fe906f" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        function saveUserData() {
            localStorage.setItem('personalLists', JSON.stringify(personalLists));
            localStorage.setItem('customOrder', JSON.stringify(customOrder));
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).set({ personalLists, customOrder }, { merge: true });
            }
        }

        function loadUserData() {
            const localLists = localStorage.getItem('personalLists');
            const localOrder = localStorage.getItem('customOrder');
            if (localLists) personalLists = JSON.parse(localLists);
            if (localOrder) customOrder = JSON.parse(localOrder);
            if (currentList === 'Favorites' && personalLists.Favorites.length === 0) {
                currentList = 'All';
            }
        }

        window.openPersonalListModal = (id) => {
            document.getElementById('listTargetMosqueId').value = id;
            renderPersonalLists();
            document.getElementById('personalListModal').classList.remove('hidden');
        };

        function renderPersonalLists() {
            const id = document.getElementById('listTargetMosqueId').value;
            const container = document.getElementById('personalListContainer');
            container.innerHTML = Object.keys(personalLists).map(listName => {
                const isAdded = personalLists[listName].includes(id);
                return `
                    <div class="flex justify-between items-center p-3 rounded-xl ${isAdded ? 'bg-brand-50 dark:bg-brand-900/30 border-brand-200' : 'bg-gray-50 dark:bg-gray-700/30 border-gray-100'} border cursor-pointer" onclick="togglePersonalList('${listName}', '${id}')">
                        <span class="text-sm font-bold ${isAdded ? 'text-brand-600' : 'text-gray-600 dark:text-gray-300'}">${listName}</span>
                        <i class="fas ${isAdded ? 'fa-check-circle text-brand-600' : 'fa-circle text-gray-200 dark:text-gray-600'}"></i>
                    </div>
                `;
            }).join('');
        }

        window.togglePersonalList = (listName, id) => {
            if (personalLists[listName].includes(id)) {
                personalLists[listName] = personalLists[listName].filter(x => x !== id);
            } else {
                personalLists[listName].push(id);
            }
            saveUserData();
            renderPersonalLists();
            renderApp();
        };

        window.createNewPersonalList = () => {
            const input = document.getElementById('newPersonalListInput');
            const name = input.value.trim();
            if (name && !personalLists[name]) {
                personalLists[name] = [];
                input.value = '';
                saveUserData();
                renderPersonalLists();
                renderListBar();
            }
        };

        window.movePersonalOrder = (id, dir) => {
            if (!customOrder.includes(id)) {
                customOrder = mosques.map(m => m.id);
            }
            const idx = customOrder.indexOf(id);
            const targetIdx = idx + dir;
            if (targetIdx >= 0 && targetIdx < customOrder.length) {
                const temp = customOrder[idx];
                customOrder[idx] = customOrder[targetIdx];
                customOrder[targetIdx] = temp;
                saveUserData();
                renderApp();
            }
        };

        function updateClock() {
            const now = new Date(); let hours = now.getHours(); const minutes = String(now.getMinutes()).padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM'; hours = hours % 12 || 12;
            currentTimeDisplay = `${hours}:${minutes} <span class="text-lg font-bold opacity-60 font-sans">${ampm}</span>`;
            const min = now.getHours() * 60 + now.getMinutes(); const isFriday = now.getDay() === 5;
            if (min >= 1350 || min < 405) currentTargetPrayer = 'fajr'; else if (min >= 405 && min < 930) currentTargetPrayer = isFriday ? 'jumma' : 'zuhr'; else if (min >= 930 && min < 1065) currentTargetPrayer = 'asr'; else currentTargetPrayer = 'isha';
            const bigClock = document.getElementById('bigClock'); if(bigClock) bigClock.innerHTML = currentTimeDisplay;
            if (viewMode === 'next') renderHeader();
        }

        function getTimeRemaining(timeStr, pid = null) {
            if(!timeStr || pid === 'eidFitr' || pid === 'eidAdha') return '';
            const now = new Date(); const [h, m] = timeStr.split(':').map(Number);
            const target = new Date(); target.setHours(h, m, 0, 0);
            if (pid === 'fajr' && now.getHours() > 20) target.setDate(target.getDate() + 1);
            if (target < now) return '(Time Passed)';
            const diff = target - now; const hrs = Math.floor(diff / 3600000); const mins = Math.floor((diff % 3600000) / 60000);
            return hrs > 0 ? `${hrs}h ${mins}m left` : `${mins}m left`;
        }

        window.tryAction = (type, callback) => {
            if (type === 'edit' && (userRole === 'volunteer' || userRole === 'admin')) return callback();
            if (type === 'admin' && userRole === 'admin') return callback();
            document.getElementById('accessDeniedModal').classList.remove('hidden');
        };

        window.openMosqueDetail = function(id) { 
            currentDetailId = id; const m = mosques.find(x => x.id === id); if(!m) return;
            document.getElementById('detail_name').innerText = m.name; document.getElementById('detail_area').innerText = m.area;
            document.getElementById('detail_notes').innerText = m.address || "No notes.";
            const dirBtn = document.getElementById('detail_directions'); if(m.locationLink) { dirBtn.href = m.locationLink; dirBtn.classList.remove('hidden'); } else { dirBtn.classList.add('hidden'); }
            const timingDiv = document.getElementById('detail_timings'); timingDiv.onclick = () => window.tryAction('edit', () => window.openEditTiming(id));
            const displayOrder = ['fajr', 'zuhr', 'jumma', 'asr', 'isha'];
            timingDiv.innerHTML = displayOrder.map(pid => {
                const data = m.timings[pid]; const hasTime = data && data.time; const pObj = prayersList.find(p => p.id === pid);
                const isIshaBox = pid === 'isha';
                const taraweehData = (isIshaBox && appSettings.ramadan && m.timings['taraweeh']?.time) ? m.timings['taraweeh'].time : null;

                return `
                <div class="flex justify-between items-center p-3.5 rounded-xl mb-2 bg-gray-50 border border-gray-100 dark:bg-gray-700/30 transition-colors ${!hasTime ? 'opacity-40' : ''}">
                    <span class="font-bold text-sm text-gray-600 dark:text-gray-400 flex items-center gap-2"><i class="fas ${pObj.icon} text-xs w-4"></i> ${pObj.name}</span>
                    <div class="text-right flex flex-col items-end">
                        <span class="${hasTime ? 'font-mono text-lg font-bold text-gray-800 dark:text-white' : 'text-[10px] text-gray-400 italic'}">${hasTime ? window.formatTime12(data.time, pid) : '(Timing not entered)'}</span>
                        ${hasTime && data.lastUpdated && !data.fixed ? `<div class="text-[8px] text-gray-300">${window.formatUpdateDate(data.lastUpdated)}</div>` : ''}
                        ${taraweehData ? `<div class="text-[9px] font-bold text-amber-800 dark:text-amber-100 mt-1 px-2 py-0.5 rounded bg-amber-400 dark:bg-amber-600 shadow-sm">Tarāweeḥ: ${taraweehData} Pārahs</div>` : ''}
                    </div>
                </div>`;
            }).join('') + specialPrayersList.map(sp => {
                if(sp.id === 'taraweeh') return '';
                if(!appSettings[sp.mode] || !m.timings[sp.id]?.time) return '';
                return `<div class="flex justify-between items-center p-3.5 rounded-xl bg-amber-50 border border-amber-100 dark:bg-amber-900/20 mt-2"><span class="font-bold text-sm text-amber-700 dark:text-amber-500"><i class="fas fa-star text-xs mr-2"></i> ${sp.name}</span><span class="font-mono text-lg font-bold text-gray-800 dark:text-white">${window.formatTime12(m.timings[sp.id].time, sp.id)}</span></div>`;
            }).join('');
            document.getElementById('mosqueDetailModal').classList.remove('hidden');
        };

        window.openMosqueModal = (id = null) => { 
            document.getElementById('mosqueInfoModal').classList.remove('hidden'); 
            const isEdit = id !== null; document.getElementById('mosqueModalTitle').innerText = isEdit ? 'Edit Masjid' : 'Add Masjid'; document.getElementById('editMosqueId').value = id || ''; 
            const delBtn = document.getElementById('btnDeleteMosqueHeader'); if(isEdit) delBtn.style.display = 'flex'; else delBtn.style.display = 'none';
            if (isEdit) { 
                const m = mosques.find(x => x.id === id); if(m) {
                    document.getElementById('m_name').value = m.name; document.getElementById('m_area').value = m.area; document.getElementById('m_link').value = m.locationLink || ''; document.getElementById('m_notes').value = m.address || ''; 
                }
            } else { 
                document.getElementById('m_name').value = 'Masjid-e-'; document.getElementById('m_area').value = ''; document.getElementById('m_link').value = ''; document.getElementById('m_notes').value = ''; 
            } 
        };

        window.openEditTiming = (id) => { editingTimingsId = id; const m = mosques.find(x => x.id === id); document.getElementById('timingModalMosqueName').innerText = m.name; document.getElementById('timingEditorContainer').innerHTML = prayersList.map(p => createTimeRow(p.id, p.name, m.timings[p.id])).join(''); document.getElementById('specialPrayersContainer').innerHTML = specialPrayersList.map(sp => createTimeRow(sp.id, sp.name, m.timings[sp.id] || {time:''}, true, sp.id === 'taraweeh' ? 'parahs' : 'time')).join(''); document.getElementById('specialPrayersContainer').classList.add('hidden'); document.getElementById('specialChevron').classList.remove('rotate-180'); document.getElementById('editTimingModal').classList.remove('hidden'); };
        
        window.openCityModal = () => {
            document.getElementById('citySelectionModal').classList.remove('hidden');
            const list = document.getElementById('cityListContainer'); list.innerHTML = '';
            Array.from(availableCities).sort().forEach(c => {
                const div = document.createElement('div'); div.className = `flex justify-between items-center p-3 mb-1 rounded-lg ${appSettings.city === c ? 'bg-brand-50 dark:bg-brand-900/20' : 'bg-gray-50 dark:bg-gray-700/30'} cursor-pointer`;
                div.innerHTML = `<span class="text-sm font-bold dark:text-white">${c}</span>${appSettings.city === c ? '<i class="fas fa-check text-brand-600"></i>' : ''}`;
                div.onclick = () => { appSettings.city = c; localStorage.setItem('city', c); document.getElementById('headerCityName').innerText = c.toUpperCase(); closeModal('citySelectionModal'); renderApp(); };
                list.appendChild(div);
            });
        };

        window.addNewCity = async () => { 
            if (userRole !== 'volunteer' && userRole !== 'admin') return window.tryAction('admin', () => {});
            const val = document.getElementById('newCityInput').value.trim();
            if(val) {
                const formatted = val.charAt(0).toUpperCase() + val.slice(1).toLowerCase();
                await db.collection('settings').doc('locations').set({ cities: firebase.firestore.FieldValue.arrayUnion(formatted) }, { merge: true });
                availableCities.add(formatted); appSettings.city = formatted; localStorage.setItem('city', formatted); document.getElementById('headerCityName').innerText = formatted.toUpperCase(); closeModal('citySelectionModal'); renderApp(); document.getElementById('newCityInput').value = '';
            }
        };

        window.saveMosqueInfo = async (goToTimings = false) => {
            if (userRole !== 'volunteer' && userRole !== 'admin') return;
            const id = document.getElementById('editMosqueId').value;
            const data = { name: document.getElementById('m_name').value, area: document.getElementById('m_area').value, city: appSettings.city, locationLink: document.getElementById('m_link').value, address: document.getElementById('m_notes').value };
            if(!data.name) return alert("Name required");
            let savedId = id; 
            if(id) await db.collection('mosques').doc(id).update(data); 
            else { 
                data.order = Date.now(); 
                data.timings = {
                    fajr: { time: "05:30", fixed: false, lastUpdated: new Date().toISOString() },
                    zuhr: { time: "13:15", fixed: true, lastUpdated: new Date().toISOString() },
                    asr: { time: "16:45", fixed: false, lastUpdated: new Date().toISOString() },
                    isha: { time: "20:00", fixed: false, lastUpdated: new Date().toISOString() },
                    jumma: { time: "13:30", fixed: true, lastUpdated: new Date().toISOString() }
                };
                const ref = await db.collection('mosques').add(data); 
                savedId = ref.id; 
            }
            showToast(); closeModal('mosqueInfoModal'); 
            if(goToTimings) window.openEditTiming(savedId);
        };

        window.saveTimings = async () => {
            if (userRole !== 'volunteer' && userRole !== 'admin') return;
            const m = mosques.find(x => x.id === editingTimingsId); if(!m) return; 
            let updated = {...m.timings};
            prayersList.forEach(p => { 
                const el = document.getElementById(`input_${p.id}`); 
                const fix = document.getElementById(`fix_${p.id}`); 
                const dateInp = document.getElementById(`date_${p.id}`); 
                if(el && el.value) updated[p.id] = { time: el.value, fixed: fix.checked, lastUpdated: dateInp && dateInp.value ? (dateInp.value + "T00:00:00Z") : (m.timings[p.id]?.lastUpdated || new Date().toISOString()) }; 
                else if (el && !el.value) delete updated[p.id];
            });
            specialPrayersList.forEach(sp => { 
                const el = document.getElementById(`input_${sp.id}`); 
                if(el && el.value) updated[sp.id] = { time: el.value }; 
                else if (el && !el.value) delete updated[sp.id];
            });
            await db.collection('mosques').doc(editingTimingsId).update({timings: updated}); 
            closeModal('editTimingModal'); showToast();
        };

        window.deleteMosque = async () => { if(confirm("Delete this masjid?")) { await db.collection('mosques').doc(document.getElementById('editMosqueId').value).delete(); closeModal('mosqueInfoModal'); showToast(); } };
        window.toggleSpecialPrayers = () => { const el = document.getElementById('specialPrayersContainer'); el.classList.toggle('hidden'); document.getElementById('specialChevron').classList.toggle('rotate-180'); };
        window.adjustTime = (key, mins) => { const el = document.getElementById(`input_${key}`); if(!el.value) return; const [h, m] = el.value.split(':').map(Number); const d = new Date(); d.setHours(h, m + mins); el.value = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; el.dispatchEvent(new Event('change')); };

        function getFilteredAndSortedMosques() {
            let filtered = mosques.filter(m => (m.city || 'Hyderabad') === appSettings.city);
            if (currentList !== 'All') {
                const personalList = personalLists[currentList] || [];
                filtered = filtered.filter(m => personalList.includes(m.id));
            }
            if (searchQuery) {
                filtered = filtered.filter(m => m.name.toLowerCase().includes(searchQuery) || m.area.toLowerCase().includes(searchQuery));
            }
            
            filtered.sort((a, b) => {
                const idxA = customOrder.indexOf(a.id);
                const idxB = customOrder.indexOf(b.id);
                if (idxA === -1 && idxB === -1) return (b.order || 0) - (a.order || 0);
                if (idxA === -1) return 1;
                if (idxB === -1) return -1;
                return idxA - idxB;
            });
            return filtered;
        }

        function renderApp() { renderHeader(); renderListBar(); const c = document.getElementById('mainContainer'); if(!c) return; if (viewMode === 'next') renderNextPrayerMode(c); else if (viewMode === 'list') renderListMode(c); else if (viewMode === 'info') renderInfoMode(c); updateNavState(); }
        
        function renderHeader() { 
            const isNextOrList = viewMode === 'next' || viewMode === 'list';
            const isNext = viewMode === 'next';
            const isInfo = viewMode === 'info';
            
            document.getElementById('headerClockView')?.classList.toggle('hidden', !isNext); 
            document.getElementById('headerSearchView')?.classList.toggle('hidden', isNext || isInfo); 
            document.getElementById('mainHeader').style.height = isNext ? '115px' : (isInfo ? '50px' : '95px');
            const wrapper = document.getElementById('scrollWrapper');
            if(wrapper) wrapper.className = isNext ? 'pt-[115px] max-w-md mx-auto px-3' : (isInfo ? 'pt-[50px] max-w-md mx-auto px-3' : 'pt-[95px] max-w-md mx-auto px-3');
            document.getElementById('btnAddFloating')?.classList.toggle('hidden', isNext || isInfo || (userRole !== 'volunteer' && userRole !== 'admin')); 
            document.getElementById('fridayBadge')?.classList.toggle('hidden', new Date().getDay() !== 5); 
            document.getElementById('filterBarContainer')?.classList.toggle('hidden', isInfo);
        }

        function renderListBar() { 
            const container = document.getElementById('listBar'); if(!container) return; 
            const coreLists = ['All', 'Favorites'];
            const others = Object.keys(personalLists).filter(l => l !== 'Favorites');
            const listsToShow = [...coreLists, ...others];
            container.innerHTML = listsToShow.map(list => `<button onclick="switchList('${list}')" class="px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all whitespace-nowrap border ${currentList === list ? 'bg-brand-600 text-white border-brand-600 shadow-md' : 'bg-white dark:bg-gray-700 text-gray-500 border-gray-200 dark:border-gray-600'}">${list}</button>`).join(''); 
        }

        function updateNavState() { document.querySelectorAll('.nav-btn').forEach(b => { b.classList.toggle('text-brand-600', b.id === `nav_${viewMode}`); b.classList.toggle('text-gray-400', b.id !== `nav_${viewMode}`); }); }

        function renderNextPrayerMode(container) {
            const list = getFilteredAndSortedMosques();
            const sequence = (function() {
                let startKey = currentTargetPrayer === 'jumma' ? 'zuhr' : currentTargetPrayer; let idx = sequenceOrder.indexOf(startKey);
                let seq = []; for(let i=0; i<4; i++) { let pid = sequenceOrder[(idx + i) % 4]; if (pid === 'zuhr' && new Date().getDay() === 5) pid = 'jumma'; seq.push(pid); } return seq;
            })();
            let html = '';
            ['eidFitr', 'eidAdha'].forEach(eidKey => {
                if(!appSettings[eidKey]) return;
                const sublist = list.filter(m => m.timings[eidKey]?.time).sort((a,b) => a.timings[eidKey].time.localeCompare(b.timings[eidKey].time));
                if(sublist.length) {
                    html += `<div class="mt-6 mb-2 flex items-center gap-2 px-1"><i class="fas fa-star text-xs text-amber-500"></i><h3 class="text-xs font-bold text-amber-600 uppercase tracking-widest">${specialPrayersList.find(s=>s.id===eidKey).name}</h3></div>`;
                    sublist.forEach(m => {
                        const t = m.timings[eidKey].time; const [h, mins] = t.split(':');
                        html += `<div onclick="openMosqueDetail('${m.id}')" class="flex justify-between items-center bg-white dark:bg-gray-800 px-4 py-2.5 rounded-xl shadow-sm border-l-[3px] border-amber-500 mb-1 animate-card"><div class="flex-1 mr-4 flex items-center gap-2"><i class="fas fa-mosque text-[10px] text-amber-400"></i><div><h4 class="font-bold text-sm truncate dark:text-white">${m.name}</h4><p class="text-[9px] text-gray-400">${m.area}</p></div></div><div class="text-right font-mono font-bold text-lg dark:text-white">${parseInt(h)%12||12}:${mins}<span class="text-[9px] ml-1">${h>=12?'PM':'AM'}</span></div></div>`;
                    });
                }
            });
            sequence.forEach((pid, idx) => {
                const sublist = list.filter(m => m.timings[pid]?.time).sort((a,b) => a.timings[pid].time.localeCompare(b.timings[pid].time));
                if(!sublist.length) return;
                html += `<div class="mt-6 mb-2 flex items-center gap-2 px-1"><i class="fas ${prayersList.find(p=>p.id===pid).icon} text-xs ${idx===0?'text-brand-500':'text-gray-400'}"></i><h3 class="text-xs font-bold uppercase tracking-widest ${idx===0?'text-brand-600 dark:text-brand-400':'text-gray-400'}">${prayersList.find(p=>p.id===pid).name}</h3></div>`;
                sublist.forEach(m => {
                    const t = m.timings[pid]; const [h, mins] = t.time.split(':'); const rem = idx === 0 ? getTimeRemaining(t.time, pid) : ''; const passed = rem === '(Time Passed)';
                    const taraweehData = (pid === 'isha' && appSettings.ramadan && m.timings['taraweeh']?.time) ? m.timings['taraweeh'].time : null;
                    
                    html += `
                    <div onclick="openMosqueDetail('${m.id}')" class="flex justify-between items-center bg-white dark:bg-gray-800 px-4 py-2.5 rounded-xl shadow-sm border-l-[3px] ${idx===0?(passed?'border-gray-300':'border-brand-500'):'border-gray-200'} mb-1 transition-all ${passed?'opacity-40 grayscale':''}">
                        <div class="flex-1 flex items-center gap-2">
                            <i class="fas fa-mosque text-[10px] text-gray-400"></i>
                            <div>
                                <h4 class="font-bold text-sm truncate dark:text-white">${m.name}</h4>
                                <p class="text-[9px] text-gray-400">${m.area}</p>
                                ${taraweehData ? `<span class="inline-block text-[8px] font-bold text-amber-800 dark:text-amber-100 mt-1 px-1.5 py-0.5 rounded bg-amber-400 dark:bg-amber-600 shadow-sm uppercase">Tarāweeḥ: ${taraweehData} P</span>` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-mono font-bold text-lg dark:text-white">${parseInt(h)%12||12}:${mins}<span class="text-[9px] ml-1">${h>=12?'PM':'AM'}</span></div>
                            ${idx===0?`<div class="text-[9px] font-bold ${passed?'text-gray-400':'text-brand-600 bg-brand-50 dark:bg-brand-900/40'} px-2 rounded">${rem}</div>`:''}
                        </div>
                    </div>`;
                });
            });
            container.innerHTML = html;
        }

        function renderListMode(container) {
            const list = getFilteredAndSortedMosques();
            if(!list.length) { container.innerHTML = `<div class="text-center mt-20 text-gray-400 text-xs font-bold uppercase tracking-widest">No Masājid found.</div>`; return; }
            container.innerHTML = list.map(m => createAdminCard(m)).join('');
        }

        function createAdminCard(m) {
            let specHTML = '';
            specialPrayersList.forEach(sp => { 
                if(sp.id === 'taraweeh') return;
                if(appSettings[sp.mode] === true && m.timings && m.timings[sp.id]?.time) 
                    specHTML += `<div class="flex justify-between px-2 py-1 bg-amber-50 dark:bg-amber-900/10 rounded mb-1 text-[9px] font-bold"><span class="text-amber-700">${sp.name}</span><span class="text-amber-800 dark:text-white">${window.formatTime12(m.timings[sp.id].time, sp.id)}</span></div>`; 
            });
            const isFav = personalLists.Favorites.includes(m.id);
            const hasLink = m.locationLink && m.locationLink.trim() !== '';

            return `<div class="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-sm border-l-[3px] border-r-[3px] border-l-brand-500 border-r-gray-100 dark:border-r-gray-700 mb-3 animate-card">
                <div class="flex justify-between items-start mb-3">
                    <div class="cursor-pointer flex items-start gap-3" onclick="openMosqueDetail('${m.id}')">
                        <i class="fas fa-mosque text-brand-500 mt-1"></i>
                        <div><h2 class="text-sm font-bold text-gray-800 dark:text-white leading-tight">${m.name}</h2><p class="text-[10px] text-gray-400">${m.area}</p></div>
                    </div>
                    <div class="flex items-center gap-1 bg-gray-50 dark:bg-gray-700/50 rounded-lg p-1">
                        <button onclick="window.movePersonalOrder('${m.id}',-1)" class="w-6 h-6 rounded flex items-center justify-center text-xs text-gray-400"><i class="fas fa-chevron-up"></i></button>
                        <button onclick="window.movePersonalOrder('${m.id}',1)" class="w-6 h-6 rounded flex items-center justify-center text-xs text-gray-400"><i class="fas fa-chevron-down"></i></button>
                        <div class="w-px h-3 bg-gray-200 dark:bg-gray-600 mx-1"></div>
                        <button onclick="openPersonalListModal('${m.id}')" class="w-6 h-6 rounded flex items-center justify-center text-xs ${isFav ? 'text-brand-600' : 'text-gray-400'}"><i class="fas fa-list-ul"></i></button>
                        ${(userRole==='admin'||userRole==='volunteer') ? `<button onclick="window.openMosqueModal('${m.id}')" class="w-6 h-6 text-brand-600 rounded flex items-center justify-center ml-1"><i class="fas fa-pencil-alt text-xs"></i></button>` : ''}
                    </div>
                </div>
                <div class="grid grid-cols-5 gap-0.5 text-center border-t border-gray-50 dark:border-gray-700 pt-3 mb-3">
                    ${prayersList.map(p => {
                        const t = m.timings[p.id]?.time; if(!t) return `<div onclick="window.tryAction('edit',()=>window.openEditTiming('${m.id}'))" class="opacity-30"><div class="text-[8px] font-bold text-gray-400 mb-1 flex flex-col items-center gap-0.5 uppercase"><i class="fas ${p.icon} text-[10px]"></i> ${p.name.slice(0,5)}</div>-</div>`;
                        const [h, mins] = t.split(':');
                        const taraweehData = (p.id === 'isha' && appSettings.ramadan && m.timings['taraweeh']?.time) ? m.timings['taraweeh'].time : null;
                        return `
                        <div onclick="window.tryAction('edit',()=>window.openEditTiming('${m.id}'))" class="cursor-pointer py-1">
                            <div class="text-[8px] font-bold text-brand-500/80 mb-1 flex flex-col items-center gap-0.5 uppercase"><i class="fas ${p.icon} text-[10px]"></i> ${p.name.slice(0,5)}</div>
                            <div class="font-mono text-sm font-bold dark:text-white">${parseInt(h)%12||12}:${mins}<span class="text-[7px] block">${h>=12?'PM':'AM'}</span></div>
                            ${taraweehData ? `<div class="mx-auto mt-1 px-1 py-0.5 rounded bg-amber-400 dark:bg-amber-600 text-[6px] font-bold text-amber-900 dark:text-amber-50 w-fit">${taraweehData}P</div>` : ''}
                        </div>`;
                    }).join('')}
                </div>
                <div>${specHTML}</div>
                <div class="flex border-t border-gray-100 dark:border-gray-700 pt-2">
                    <button onclick="document.getElementById('notes_${m.id}').classList.toggle('hidden')" class="flex-1 text-[10px] font-bold text-gray-400 uppercase">Notes <i class="fas fa-chevron-down"></i></button>
                    ${hasLink ? 
                        `<a href="${m.locationLink}" target="_blank" class="flex-1 text-[10px] font-bold text-brand-600 text-center uppercase">Maps <i class="fas fa-location-arrow"></i></a>` :
                        `<span class="flex-1 text-[10px] font-bold text-gray-300 text-center uppercase cursor-not-allowed">Maps <i class="fas fa-location-arrow"></i></span>`
                    }
                </div>
                <div id="notes_${m.id}" class="hidden bg-gray-50 dark:bg-gray-700/30 p-3 text-[10px] border-t mt-2 dark:text-gray-300">${m.address||'No notes.'}</div>
            </div>`;
        }

        function renderInfoMode(container) {
            const shareMessage = encodeURIComponent(`السلام عليكم ورحمة الله وبركاته 🌙

🌙 This Ramadān, stay connected to the Masjid — on time, every time.

We’re pleased to introduce Jamaat on Time — a simple and useful web app to help you keep track of jamāʿah timings across various masājid.

✨ Features include:
• 🕌 Jamāʿah timings for multiple masājid (including Jumuʿah)
• 🌙 Tarāweeḥ details
• 🎉 Eid prayer timings
• ⭐ Add nearby masājid to your Favorites list
• 🔎 Instantly search by area, masjid name, or timing
• 📱 Easy access from your phone (add to Home Screen for quick use)

🔗 Access the web app here:
https://aekae47.github.io/jamaat-timings/

📢 Join our Telegram group for updates & feedback:
https://t.me/+cjZjOMlnINUxMmU1

If you find it beneficial, please share it with your family and friends — may it be a means of khayr for all of us.

جزاك الله خيرًا
والسلام عليكم ورحمة الله وبركاته 🌿`);
            
            container.innerHTML = `
                <div class="animate-card max-w-sm mx-auto pt-6 space-y-8 pb-10">
                    <div class="flex justify-center">
                        <img src="assets/bismillah-jot1.png" class="h-16 w-auto opacity-80 dark:invert" alt="Bismillah">
                    </div>
                    
                    <p class="text-center text-sm font-medium text-gray-600 dark:text-gray-300 leading-relaxed italic px-2">
                        "Alḥamdulillāh, Allāh ﷻ has given us this opportunity to be of some use to the Ummah, by creating this tool. Our sole intention is to help our brethren to be more punctual in their jamāʿah prayers."
                    </p>

                    <div class="space-y-3">
                        <h3 class="text-[10px] font-bold uppercase text-gray-400 tracking-widest ml-1">Frequently Asked Questions</h3>
                        
                        ${createFAQItem("Why are there no Maghrib timings?", "Maghrib timings are usually the same in all the masājid around us, around sunset, and is not difficult for most people to be reminded. Hence for simplicity of the app, we haven't included them. The purpose of this app is not to show starting and ending times of various salāhs (there are many other good apps for that), but to compile & show the jamāʿah times in various local masājid.")}
                        
                        ${createFAQItem("My nearby masjid timings are missing, what to do?", 'You can contribute to our timings database via our <a href="https://t.me/+cjZjOMlnINUxMmU1" target="_blank" class="text-brand-600 underline">Telegram group</a>.')}

                        ${createFAQItem("How do I install this app?", "On Android, just open the sidebar of this web app, and click on 'Install App', and drag the icon to your home screen. Or select 'Add to Home Screen' in yor browser menu. On iOS, click share from your browser, the select 'Add to Home Screen'.")}
                        
                        ${createFAQItem("How reliable are these timings?", "These rely on contributions by volunteers. Most of them are reliable but some may be wrong. You can report wrong timings in our Telegram group.")}
                        
                        ${createFAQItem("Who has made this app?", "Some well-wishers of the ummah, aided with the help of many volunteers has developed this. We are not professionals, hence we can make mistakes. We ask for your forgiveness in case of any mistakes, and only ask you to make duʿāʾ for us.")}
                    </div>

                    <div class="pt-4">
                        <a href="https://t.me/+cjZjOMlnINUxMmU1" target="_blank" class="flex items-center justify-center gap-3 w-full py-4 bg-[#24A1DE] text-white rounded-2xl shadow-lg hover:brightness-110 transition-all">
                            <i class="fab fa-telegram-plane text-xl"></i>
                            <span class="text-sm font-bold uppercase tracking-wider">Join Telegram Group</span>
                        </a>
                        <a href="https://wa.me/?text=${shareMessage}" target="_blank" class="flex items-center justify-center gap-3 w-full py-4 bg-[#25D366] text-white rounded-2xl shadow-lg hover:brightness-110 transition-all">
                            <i class="fab fa-whatsapp text-xl"></i>
                            <span class="text-sm font-bold uppercase tracking-wider">Share on WhatsApp</span>
                        </a>
                    </div>

                    <div class="pt-8 pb-4 text-center">
                        <p class="text-[10px] font-medium text-gray-400 dark:text-gray-500 uppercase tracking-[0.2em]">
                            Made with <span class="text-red-400 dark:text-red-500/70 mx-0.5">♡</span> in Hyderabad, India
                        </p>
                    </div>
                </div>
            `;
        }

        function createFAQItem(q, a) {
            const id = 'faq_' + Math.random().toString(36).substr(2, 9);
            return `
                <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700 overflow-hidden shadow-sm">
                    <button onclick="document.getElementById('${id}').classList.toggle('hidden'); this.querySelector('i').classList.toggle('rotate-180')" class="w-full flex items-center justify-between p-4 text-left">
                        <span class="text-xs font-bold text-gray-700 dark:text-gray-200">${q}</span>
                        <i class="fas fa-chevron-down text-[10px] text-gray-400 transition-transform"></i>
                    </button>
                    <div id="${id}" class="hidden px-4 pb-4 text-xs text-gray-500 dark:text-gray-400 leading-relaxed border-t border-gray-50 dark:border-gray-700 pt-3">
                        ${a}
                    </div>
                </div>
            `;
        }

        function createTimeRow(key, name, data, isSpecial = false, type = 'time') { 
            const timeVal = data?.time || ''; const isFixed = data?.fixed || false; const lastUpd = data?.lastUpdated ? data.lastUpdated.split('T')[0] : new Date().toISOString().split('T')[0]; 
            if (type === 'parahs') return `<div class="bg-white dark:bg-gray-800 border-b border-gray-100 dark:border-gray-700 pb-3 mb-3 last:border-0"><div class="flex items-center gap-3 mb-2"><span class="font-bold text-xs w-16 text-gray-500 uppercase tracking-wide">${name}<br><span class="text-[8px] text-gray-400 font-normal">(in Pārahs)</span></span><input type="number" step="0.25" id="input_${key}" value="${timeVal}" class="flex-1 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl px-3 py-2 text-center font-mono font-bold outline-none dark:text-white"></div></div>`; 
            return `<div class="bg-white dark:bg-gray-800 border-b border-gray-100 dark:border-gray-700 pb-3 mb-3 last:border-0 last:mb-0"><div class="flex items-center gap-3 mb-2"><span class="font-bold text-sm text-gray-700 dark:text-gray-300 w-20">${name}</span><div class="flex-1 relative h-10"><div id="display_${key}" class="absolute inset-0 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-600 rounded-xl flex items-center justify-center font-mono font-bold pointer-events-none dark:text-white">${window.formatTime12(timeVal, key)}</div><input type="time" id="input_${key}" value="${timeVal}" onchange="document.getElementById('display_${key}').innerHTML = window.formatTime12(this.value, '${key}')" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"></div><div class="flex flex-col gap-1"><button onclick="document.getElementById('input_${key}').value=''; document.getElementById('display_${key}').innerHTML='--:--'" class="text-gray-400 hover:text-red-500 w-8 h-8"><i class="fas fa-trash text-xs"></i></button>${!isSpecial ? `<div class="relative w-8 h-8 flex items-center justify-center text-brand-500 ${isFixed?'hidden':''}" id="date_wrap_${key}"><i class="fas fa-calendar-alt text-[10px]"></i><input type="date" id="date_${key}" value="${lastUpd}" class="absolute inset-0 opacity-0 cursor-pointer"></div>` : ''}</div></div><div class="flex justify-between items-center pl-[5.5rem] pr-12">${!isSpecial ? `<label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="fix_${key}" ${isFixed ? 'checked' : ''} class="w-4 h-4 accent-brand-600 rounded" onchange="document.getElementById('date_wrap_${key}').classList.toggle('hidden', this.checked)"><span class="text-[10px] uppercase font-bold text-gray-400">Same all year</span></label>` : '<div></div>'}<div class="flex gap-2"><button onclick="adjustTime('${key}',-5)" class="px-2.5 py-1 bg-gray-100 dark:bg-gray-700 dark:text-gray-300 rounded text-[10px] font-bold">- 5</button><button onclick="adjustTime('${key}',5)" class="px-2.5 py-1 bg-gray-100 dark:bg-gray-700 dark:text-gray-300 rounded text-[10px] font-bold">+ 5</button></div></div></div>`; 
        }

        async function init() {
            loadUserData();
            appSettings.theme = localStorage.getItem('theme') || 'light';
            appSettings.city = localStorage.getItem('city') || 'Hyderabad';
            document.documentElement.classList.toggle('dark', appSettings.theme === 'dark');
            const toggEl = document.getElementById('theme_toggle'); if(toggEl) toggEl.checked = appSettings.theme === 'dark';
            const cityEl = document.getElementById('headerCityName'); if(cityEl) cityEl.innerText = appSettings.city.toUpperCase();
            
            auth.onAuthStateChanged(async (user) => {
                currentUser = user;
                if (user) {
                    document.getElementById('loginSection').classList.add('hidden'); document.getElementById('authSection').classList.remove('hidden');
                    document.getElementById('userPhoto').src = user.photoURL; document.getElementById('userName').innerText = user.displayName;
                    const doc = await db.collection('users').doc(user.uid).get();
                    if (doc.exists) {
                        const data = doc.data();
                        userRole = data.role || 'user';
                        if (data.personalLists) personalLists = data.personalLists;
                        if (data.customOrder) customOrder = data.customOrder;
                    } else {
                        userRole = 'user';
                        await db.collection('users').doc(user.uid).set({ email: user.email, name: user.displayName, role: 'user', personalLists, customOrder, createdAt: new Date().toISOString() });
                    }
                    document.getElementById('userRoleBadge').innerText = userRole;
                } else {
                    document.getElementById('loginSection').classList.remove('hidden'); document.getElementById('authSection').classList.add('hidden');
                    userRole = 'public';
                }
                updateUIForRole(); loadData();
            });
            db.collection('settings').doc('global_modes').onSnapshot(doc => { if(doc.exists) { const d = doc.data(); Object.keys(appSettings).forEach(k => { if(k!=='theme' && k!=='city' && d[k]!==undefined) appSettings[k] = d[k]; }); window.updateSidebarToggles(); renderApp(); } });
            db.collection('settings').doc('locations').onSnapshot(doc => { if(doc.exists && doc.data().cities) doc.data().cities.forEach(c => availableCities.add(c)); });
            updateClock(); setInterval(updateClock, 1000);
        }

        function updateUIForRole() {
            const canEdit = (userRole === 'volunteer' || userRole === 'admin');
            const isAdmin = (userRole === 'admin');
            document.querySelectorAll('#btnAddFloating, .fa-pencil-alt, #btnDeleteMosqueHeader, #btnEditDetail').forEach(el => { el.closest('button')?.classList.toggle('restricted', !canEdit); });
            const sCont = document.getElementById('seasonalContainer'); if(sCont) sCont.classList.toggle('restricted', !isAdmin);
        }

        function loadData() { db.collection('mosques').onSnapshot(snap => { mosques = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderApp(); }); }
        window.onload = init;
    </script>
</body>
</html>
