<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jamaat on Time</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Playfair+Display:wght@700&family=Source+Code+Pro:wght@600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script type="module">
/* ===============================
   FIREBASE v9 MODULAR + OFFLINE
================================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import {
  getFirestore,
  collection,
  onSnapshot,
  addDoc,
  updateDoc,
  deleteDoc,
  doc,
  enableIndexedDbPersistence
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSy...",
  authDomain: "timings-ak.firebaseapp.com",
  projectId: "timings-ak"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ðŸ”¥ Enable Offline Cache
enableIndexedDbPersistence(db).catch(() => {
  console.log("Offline persistence not available");
});

/* ===============================
   STATE
================================= */
let mosques = [];
let currentList = "Favorites";
let viewMode = "next";
let currentDetailId = null;

/* ===============================
   INITIAL LOAD
================================= */
const mosqueCol = collection(db, "mosques");

onSnapshot(mosqueCol, (snapshot) => {
  mosques = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
  renderApp();
});

/* ===============================
   MODAL ANIMATION
================================= */
function openModal(id) {
  const m = document.getElementById(id);
  m.classList.remove("hidden");
  setTimeout(() => {
    m.classList.add("opacity-100", "scale-100");
  }, 10);
}

function closeModal(id) {
  const m = document.getElementById(id);
  m.classList.remove("opacity-100", "scale-100");
  setTimeout(() => m.classList.add("hidden"), 200);
}

/* ===============================
   OPEN ADD / EDIT MOSQUE
================================= */
window.openMosqueModal = function(id=null){

  openModal("mosqueInfoModal");

  const isEdit = !!id;
  document.getElementById("mosqueModalTitle").innerText =
    isEdit ? "Edit Mosque" : "Add Mosque";

  document.getElementById("editMosqueId").value = id || "";

  const deleteBtn = document.getElementById("btnDeleteMosque");
  deleteBtn.classList.toggle("hidden", !isEdit);

  const listContainer = document.getElementById("listChipsContainer");
  const allLists = [...new Set(mosques.flatMap(m => m.lists || []))];

  listContainer.innerHTML = allLists.map(l => `
    <label class="flex items-center gap-2 text-xs">
      <input type="checkbox" value="${l}" class="list-check accent-brand-600">
      ${l}
    </label>
  `).join("");

  if(isEdit){
    const m = mosques.find(x=>x.id===id);
    if(!m) return;

    document.getElementById("m_name").value = m.name;
    document.getElementById("m_area").value = m.area||"";
    document.getElementById("m_notes").value = m.address||"";
    document.getElementById("m_link").value = m.locationLink||"";

    document.querySelectorAll(".list-check").forEach(c=>{
      if(m.lists?.includes(c.value)) c.checked=true;
    });

  }else{
    const nameInput = document.getElementById("m_name");
    nameInput.value="Masjid-e-";
    nameInput.focus();
    nameInput.setSelectionRange(nameInput.value.length,nameInput.value.length);
  }
};

/* ===============================
   SAVE MOSQUE (OPTIMISTIC UI)
================================= */
window.saveMosqueInfo = async function(){

  const id = document.getElementById("editMosqueId").value;
  const name = document.getElementById("m_name").value;
  if(!name) return alert("Enter name");

  const selectedLists =
    [...document.querySelectorAll(".list-check:checked")]
      .map(c=>c.value);

  const data = {
    name,
    area: document.getElementById("m_area").value,
    address: document.getElementById("m_notes").value,
    locationLink: document.getElementById("m_link").value,
    lists: selectedLists.length?selectedLists:["Favorites"],
    timings: {}
  };

  closeModal("mosqueInfoModal");

  if(id){
    // optimistic update
    const idx = mosques.findIndex(m=>m.id===id);
    mosques[idx]={...mosques[idx],...data};
    renderApp();

    await updateDoc(doc(db,"mosques",id),data);

  }else{
    // optimistic add
    const tempId="temp_"+Date.now();
    mosques.push({id:tempId,...data});
    renderApp();

    const docRef = await addDoc(mosqueCol,data);
    mosques = mosques.map(m=>m.id===tempId?{...m,id:docRef.id}:m);
    renderApp();
  }
};

/* ===============================
   DELETE MOSQUE
================================= */
window.deleteMosque = async function(){
  const id=document.getElementById("editMosqueId").value;
  if(!confirm("Delete?")) return;

  closeModal("mosqueInfoModal");

  mosques=mosques.filter(m=>m.id!==id);
  renderApp();

  await deleteDoc(doc(db,"mosques",id));
};

/* ===============================
   DETAIL MODAL
================================= */
window.openMosqueDetail=function(id){
  const m=mosques.find(x=>x.id===id);
  if(!m) return;

  currentDetailId=id;

  document.getElementById("detail_name").innerText=m.name;
  document.getElementById("detail_area").innerText=m.area||"";
  document.getElementById("detail_notes").innerText=m.address||"";
  document.getElementById("detail_directions").href=m.locationLink||"#";

  openModal("mosqueDetailModal");
};

/* ===============================
   RENDER (MINIMAL RE-RENDER)
================================= */
function renderApp(){
  const container=document.getElementById("mainContainer");
  container.innerHTML=
    mosques.map(m=>`
      <div onclick="openMosqueDetail('${m.id}')"
           class="bg-white p-3 rounded-xl shadow mb-3 cursor-pointer">
        <div class="font-bold">${m.name}</div>
        <div class="text-xs text-gray-400">${m.area||""}</div>
      </div>
    `).join("");
}

</script>

<style>
.modal-base{
  transition: all .2s ease;
  opacity:0;
  transform:scale(.95);
}
.modal-base.opacity-100{
  opacity:1;
}
.modal-base.scale-100{
  transform:scale(1);
}
</style>
</head>

<body class="bg-gray-50 p-4">

<div id="mainContainer"></div>

<button onclick="openMosqueModal()"
class="fixed bottom-5 right-5 bg-teal-600 text-white w-14 h-14 rounded-full">
+
</button>

<!-- MOSQUE INFO MODAL -->
<div id="mosqueInfoModal"
class="hidden modal-base fixed inset-0 bg-black/50 flex items-center justify-center">

<div class="bg-white p-6 rounded-xl w-80">

<h3 id="mosqueModalTitle" class="font-bold mb-3">Add Mosque</h3>

<input type="hidden" id="editMosqueId">

<input id="m_name" class="border w-full mb-2 p-2" placeholder="Name">
<input id="m_area" class="border w-full mb-2 p-2" placeholder="Area">

<div id="listChipsContainer" class="mb-2"></div>

<input id="m_link" class="border w-full mb-2 p-2" placeholder="Maps link">
<textarea id="m_notes" class="border w-full mb-2 p-2" placeholder="Notes"></textarea>

<div class="flex justify-between">
<button id="btnDeleteMosque"
onclick="deleteMosque()"
class="text-red-500 hidden">Delete</button>

<div>
<button onclick="closeModal('mosqueInfoModal')">Cancel</button>
<button onclick="saveMosqueInfo()">Save</button>
</div>
</div>

</div>
</div>

<!-- DETAIL MODAL -->
<div id="mosqueDetailModal"
class="hidden modal-base fixed inset-0 bg-black/50 flex items-center justify-center">

<div class="bg-white p-6 rounded-xl w-80">

<h3 id="detail_name" class="font-bold"></h3>
<div id="detail_area" class="text-xs text-gray-400 mb-2"></div>
<p id="detail_notes" class="text-sm mb-2"></p>

<a id="detail_directions"
class="text-teal-600 text-sm"
target="_blank">Directions</a>

<div class="mt-4 text-right">
<button onclick="closeModal('mosqueDetailModal')">Close</button>
</div>

</div>
</div>

</body>
</html>
